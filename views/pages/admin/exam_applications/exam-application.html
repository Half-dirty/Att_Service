<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../../style/style.css">
    <link rel="stylesheet" href="../../../style/student/global.css">
    <link rel="stylesheet" href="../../../style/admin/global.css">
    <link rel="stylesheet" href="../../../style/student/applications.css">
    <title>Document</title>
</head>

<body data-id="{{.AppID}}">
    <div class="wrapper">
        <header class="header">
            <div class="header__container">
                <a class="header__logo" href="/">
                    <img class="header__logo-img" src="../../../pictures/logo.svg" alt="Logo" />
                    <div class="header__logo-text__container">
                        <h2 class="header__logo-text">Аттестация переводчиков русского жестового языка</h2>
                    </div>
                </a>
                <input type="checkbox" id="menu-toggle" class="header__menu-toggle">
                <label for="menu-toggle" class="header__menu-icon">
                    <span></span>
                </label>

                <div class="header__profile">
                    <div class="header__profile-info">
                        <div class="header__status">
                            <h2>Статус:</h2>
                            {{if or (eq .status "pending") (eq .status "")}}
                            <h2 class="header__status-text header__status-text--inactive">Не подтвержден</h2>
                            <a href="#" class="header__status-button popup__link" name="aplication_form">Отправить на
                                проверку</a>
                            {{end}}
                            {{if eq .status "declined"}}
                            <a href="#" class="header__status-button aproove_form" name="aproove_form">Отказ</a>
                            <a href="#" class="header__status-button popup__link" name="aplication_form">Отправить на
                                проверку</a>
                            {{end}}
                            {{if eq .status "approved"}}
                            <h2 class="header__status-text header__status-text--active">Подтвержден</h2>
                            {{end}}
                        </div>
                        <div class="header__role">
                            <h2>Роль:</h2>
                            {{if eq .role "student"}}
                            <h2 class="header__role-text header__role-text--student">Аттестуемый</h2>
                            {{else if eq .role "examiner"}}
                            <h2 class="header__role-text header__role-text--examiner">Экзаменатор</h2>
                            {{end}}
                        </div>
                    </div>
                    <img class="header__profile-avatar"
                        src="{{if .avatar}}{{.avatar}}{{else}}../../../pictures/Generic avatar.png{{end}}"
                        alt="Profile Avatar">
                </div>
            </div>
        </header>

        <main class="main main--admin">
            <nav class="menu">
                <ul class="menu__list">
                    <!-- <li class="menu__item menu__item--active">
                        <a href="/admin/exam/students" class="menu__button">Заявки на экзамен</a>
                    </li> -->
                    <li class="menu__item--back">
                        <a href="/admin/exam/students">назад</a>
                    </li>
                </ul>
            </nav>

            <section class="profile">
                <form class="profile__body" enctype="multipart/form-data">
                    <div class="profile__form">
                        <div class="profile__column">
                            <div class="profile__placeholder">
                                <label class="profile__label" for="native_language">Родной язык:</label>
                                <input class="profile__input" type="text" name="native_language" id="native_language"
                                    value="{{.native_language}}" placeholder="">
                            </div>
                        </div>
                        <div class="profile__column">
                            <div class="profile__placeholder">
                                <label class="profile__label" for="citizenship">Гражданство:</label>
                                <input class="profile__input" type="text" name="citizenship" id="citizenship"
                                    placeholder="" value="{{.citizenship}}">
                            </div>
                        </div>
                        <div class="profile__column">
                            <div class="profile__placeholder">
                                <label class="profile__label" for="marital_status">Семейное положение:</label>
                                <input class="profile__input" type="text" name="marital_status" id="marital_status"
                                    value="{{.marital_status}}" placeholder="">
                            </div>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="organization">Организация:</label>
                            <input class="profile__input" type="text" name="organization" id="organization"
                                value="{{.organization}}" placeholder="">
                        </div>
                        <div class="profile__column">
                            <div class="profile__placeholder">
                                <label class="profile__label" for="job_position">Занимая должность:</label>
                                <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                    oninput="adjustHeight(this)" name="job_position"
                                    id="job_position">{{.job_position}}</textarea>
                            </div>
                        </div>
                        <div class="profile__column">
                            <div class="profile__placeholder">
                                <label class="profile__label" for="requested_category">Запрашиваемая категория
                                    аттестации:</label>
                                <select class="profile__selector" name="requested_category" id="requested_category">
                                    {{range .requested_category_list}}
                                    <option value="{{.Value}}" {{if .Selected}}selected{{end}}>{{.Text}}</option>
                                    {{end}}
                                </select>
                            </div>
                        </div>
                        <div class="profile__column">
                            <div class="profile__placeholder">
                                <label class="profile__label" for="basis_for_attestation">Основанием для аттестации на
                                    указанную в заявлении квалификационную категорию считаю следующие результаты
                                    работы:</label>
                                <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                    oninput="adjustHeight(this)" name="basis_for_attestation"
                                    id="basis_for_attestation">{{.basis_for_attestation}}</textarea>
                            </div>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="existing_category">Имеющаяся в наличии квалификационная
                                категория:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="existing_category"
                                id="existing_category">{{.existing_category}}</textarea>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="existing_category_term">Срок действия имеющейся
                                квалификационной категории:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="existing_category_term"
                                id="existing_category_term">{{.existing_category_term}}</textarea>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="work_experience">Стаж работы (по специальности) полных
                                лет:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="work_experience"
                                id="work_experience">{{.work_experience}}</textarea>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="current_position_experience">Стаж работы в настоящей
                                должности полных лет:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="current_position_experience"
                                id="current_position_experience">{{.current_position_experience}}</textarea>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="awards_info">Наличие наград, званий, учёной степени,
                                учёного звания:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="awards_info"
                                id="awards_info">{{.awards_info}}</textarea>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="training_info">Сведения о повышении квалификации:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="training_info"
                                id="training_info">{{.training_info}}</textarea>
                        </div>
                        <div class="profile__column">
                            <label class="profile__label" for="memberships">Членство в организациях:</label>
                            <textarea class="profile__textarea profile__textarea-auto_expand" rows="1"
                                oninput="adjustHeight(this)" name="memberships"
                                id="memberships">{{.memberships}}</textarea>
                        </div>
                    </div>
                    <div class="profile__row">
                        <div class="profile__scan">
                            <label class="profile__label" for="scan_diploma">Скан диплома об образовании:</label>
                            <div class="uploadContainer profile__scan--input">
                                <input type="file" name="diplom_img" id="scan_diploma" accept="image/*" hidden
                                    class="scan__input" data-id="diplom_img" multiple>
                                <div id="diplom_img" name="diplom_img" class="image-preview">
                                    {{range .diplom_images}}
                                    <img src="{{.}}" alt="Диплом">
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile__row">
                        <div class="profile__scan">
                            <label class="profile__label" for="scan_diploma_znii">Скан диплома о подготовке по жестовому
                                языку:</label>
                            <div class="uploadContainer profile__scan--input">
                                <input type="file" name="diplom_znii_img" id="scan_diploma_znii" accept="image/*" hidden
                                    class="scan__input" data-id="diplom_znii_img" multiple>
                                <div id="diplom_znii_img" name="diplom_znii_img" class="image-preview">
                                    {{range .diplom_jest_images}}
                                    <img src="{{.}}" alt="Диплом Жестовый">
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile__row">
                        <div class="profile__scan">
                            <label class="profile__label" for="passport_all">Сканы паспорта:</label>
                            <div class="uploadContainer profile__scan--input">
                                <input type="file" name="passport_all" id="passport_all" accept="image/*" hidden
                                    class="scan__input" multiple data-id="passport_all_preview">
                                <div id="passport_all_preview" class="image-preview">
                                    {{range .passport_images}}
                                    <img src="{{.}}" alt="Паспорт">
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile__row">
                        <div class="profile__scan">
                            <label class="profile__label" for="tk_book">Сканы трудовой книжки:</label>
                            <div class="uploadContainer profile__scan--input">
                                <input type="file" name="tk_book" id="tk_book" accept="image/*" hidden
                                    class="scan__input" multiple data-id="tk_book_preview">
                                <div id="tk_book_preview" class="image-preview">
                                    {{range .tk_book_images}}
                                    <img src="{{.}}" alt="трудовая книжка">
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile__row">
                        <div class="profile__scan">
                            <label class="profile__label" for="characteristic">Скан характеристики:</label>
                            <div class="uploadContainer profile__scan--input">
                                <input type="file" name="characteristic" id="characteristic" accept="image/*" hidden
                                    class="scan__input" multiple data-id="characteristic">
                                <div id="characteristic" class="image-preview">
                                    {{range .characteristic_images}}
                                    <img src="{{.}}" alt="характеристика">
                                    {{end}}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="profile__row">
                        <div class="profile__confirm">
                            <label class="profile__confirm-label" for="memberships">Согласие на обработку ваших
                                персональных
                                данных:</label>
                            <input type="checkbox" name="consent" value="true" {{if .consent}}checked{{end}}>
                        </div>
                        <div class="profile__agree">
                            <button type="button" class="profile__agree-button" id="agree_application">Подтвердить
                                заявление</button>
                            <button type="button" class="profile__decline-button"
                                id="decline_application_button">Отклонить заявление</button>
                        </div>
                    </div>
                </form>
            </section>
        </main>


        <footer class="footer"></footer>
    </div>
    <div id="custom-alert" class="custom-alert hidden"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.5/jquery.inputmask.min.js"></script>
    <script src="../../../scripts/student_script.js"></script>
    <script src="../../../scripts/admin_script.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll("input, textarea, select").forEach(el => {
                if (el.type === "file") {
                    el.disabled = true;
                } else if (el.tagName === "SELECT") {
                    el.disabled = true;
                } else if (el.type === "checkbox" || el.type === "radio") {
                    el.disabled = true;
                } else {
                    el.readOnly = true;
                }
            });
        });
    </script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            document.querySelectorAll("input, textarea, select").forEach(el => {
                if (el.type === "file") {
                    el.disabled = true;
                } else if (el.tagName === "SELECT") {
                    el.disabled = true;
                } else if (el.type === "checkbox" || el.type === "radio") {
                    el.disabled = true;
                } else {
                    el.readOnly = true;
                }
            });

            // 🔥 Новый код: клик по картинке — скачивание файла
            document.querySelectorAll(".image-preview img").forEach(img => {
                img.style.cursor = "pointer";
                img.addEventListener("click", () => {
                    const link = document.createElement('a');
                    link.href = img.src;
                    link.download = img.alt || "document"; // название файла
                    link.target = "_blank";
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                });
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            const appID = $('body').data('id');

            const postRequest = (url, data, successRedirect) => {
                if (!appID) {
                    alert("Ошибка: ID заявки не найден");
                    return;
                }

                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "application/json",
                    data: JSON.stringify(data),
                    success: function (res) {
                        if (res.success) {
                            window.location.href = successRedirect;
                        } else {
                            alert("Ошибка при обработке запроса");
                        }
                    },
                    error: function (xhr) {
                        alert("Ошибка сервера: " + (xhr.responseText || xhr.statusText));
                    }
                });
            };
        });
        $('#decline_application_button').on('click', function (e) {
            e.preventDefault();
            openModal("decline_application_modal");
        });
        $(document).on('submit', '#decline_application-form', function (e) {
            e.preventDefault();  // Отменяем стандартное поведение формы

            // Если кнопка отправки неактивна
            if ($('.popup__send').hasClass('popup__send--disabled')) return;

            const reasons = [];
            // Собираем причины отказа
            $('input[name="reason"]:checked').each(function () {
                reasons.push($(this).val());
            });

            const explanation = $('textarea[name="explanation"]').val();
            const appID = $('body').data('id');

            if (!appID) {
                alert("Ошибка: не найден ID заявления");
                return;
            }

            // Отправляем данные на сервер
            apiPost("/admin/api/application/decline", { id: appID, reasons, explanation })
                .done(() => window.location.href = "/admin/exam/students")  // Переход на страницу после успеха
                .fail(xhr => alert("Ошибка при отправке: " + xhr.responseText));  // Обработка ошибок
        });
        const adminModals = {
            decline_form: `
    <div id="decline_form" class="popup">
        <div class="popup__body">
            <div class="popup__content">
                <div class="popup__header">
                    <a href="#" class="popup__close close-popup"><span></span></a>
                    <h2 class="popup__title">Укажите причину отказа:</h2>
                </div>
                <form id="decline-forma">
                    <label><input type="checkbox" name="reason" value="invalid_name"> Неверно указанное ФИО</label>
                    <label><input type="checkbox" name="reason" value="invalid_contacts"> Неверно указанные контакты</label>
                    <label><input type="checkbox" name="reason" value="no_documents"> Не все документы</label>
                    <textarea name="explanation" placeholder="Пояснение"></textarea>
                    <button type="submit">Отправить</button>
                </form>
            </div>
        </div>
    </div>`,
            decline_application_modal: `
<div id="decline_application_modal" class="popup">
    <div class="popup__body">
        <div class="popup__content">
            <div class="popup__header">
                <a href="#" class="popup__close close-popup"><span></span></a>
                <h2 class="popup__title">Укажите причину отказа:</h2>
            </div>
            <form id="decline_application-form" class="popup__form">
                <div class="popup__checker">
                    <div class="popup__list">
                        <label class="popup__item">
                            <input type="checkbox" name="reason" value="invalid_name"> Неверно указанные данные
                        </label>
                        <label class="popup__item">
                            <input type="checkbox" name="reason" value="invalid_contacts"> Прикреплены не соответствующие фото
                        </label>
                        <label class="popup__item">
                            <input type="checkbox" name="reason" value="no_documents"> Прикреплены не все документы
                        </label>
                        <div class="popup__textarea">
                            <textarea placeholder="Напишите пояснение" name="explanation"></textarea>
                        </div>
                    </div>
                    <div class="popup__send popup__send">
                        <button type="submit" class="">Отправить</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
`,

            'start-exam': `
<div id="start-exam" class="popup">
    <div class="popup__body">
        <div class="popup__content">
            <div class="popup__header">
                <a href="#" class="popup__close close-popup"><span></span></a>
                <h2 class="popup__title">Экзаменаторы подключившиеся к экзамену:</h2>
            </div>
            <div class="popup__form">
                <div class="popup__examiner-list" id="examiner_list">
                    <!-- сюда динамически вставим экзаменаторов -->
                </div>
                <div class="popup__start">
                    <button type="button" id="start_exam_confirm">Начать экзамен</button>
                </div>
            </div>
        </div>
    </div>
</div>`,

        };
        const apiPost = (url, data) => {
            return $.ajax({
                type: 'POST',
                url,
                contentType: 'application/json',
                data: JSON.stringify(data),
            });
        };

        $('#agree_application').on('click', function (e) {
            e.preventDefault();

            const appID = $('body').data('id');

            if (!appID) {
                alert("Ошибка: не удалось получить ID заявления");
                return;
            }

            $.ajax({
                url: '/admin/api/application/approve',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ id: appID }),
                success: function (response) {
                    window.location.href = "/admin/exam/students";
                },
                error: function (xhr) {
                    alert("Ошибка подтверждения: " + xhr.responseText);
                }
            });
        });

        function openModal(name) {
            const modalTemplate = adminModals[name];  // Получаем шаблон модалки
            if (!modalTemplate) {
                console.error("Модалка не найдена:", name);
                return;
            }

            // Удаляем предыдущую модалку, если такая уже существует
            $('.popup#' + name).remove();
            // Добавляем новую модалку в контейнер
            $('.wrapper').append(modalTemplate);

            // Добавляем классы для отображения модалки
            $('#' + name).addClass('popup__open');
            $('body').addClass('modal');

            // Закрытие модалки по крестику
            $('#' + name).find('.popup__close').on('click', function (e) {
                e.preventDefault();
                closeModal(name);
            });

            // Закрытие по клику вне модалки
            $(document).on('click.modal', `#${name}`, function (e) {
                if (!$(e.target).closest('.popup__content').length) {
                    closeModal(name);
                }
            });

            // Закрытие по клавише Escape
            $(document).on('keydown.modal', function (e) {
                if (e.key === 'Escape') {
                    closeModal(name);
                }
            });
        }


        function closeModal(name) {
            $('.popup#' + name).remove(); // ❗ Тоже удаляем только popup по id
            $('body').removeClass('modal');
            $(document).off('click.modal');
            $(document).off('keydown.modal');
        }
    </script>

</body>

</html>